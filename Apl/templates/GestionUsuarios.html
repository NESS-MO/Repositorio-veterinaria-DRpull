{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Veterinaria</title>
    <link rel="icon" href="{% static 'Images/logo.png' %}"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/GestionCitas.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-container {
            margin-left: 19rem;
            padding: 2rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        td {
            font-size:18px;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color:black;
            font-size:16px;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 50%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .password-toggle {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }
        .error-message {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        #passwordFields {
            transition: all 0.3s ease;
        }
        .hidden {
            display: none !important;
        }
        .user-info {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            position: absolute;
            bottom: 0;
            width: 100%;
            left: 0;
        }
        .user-info p {
            margin: 0.25rem 0;
            text-align: center;
        }
        /* Estilos para los filtros */
        #filtrosContainer {
            transition: all 0.3s ease;
        }
        .highlight {
            background-color: #f0f7ff;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="w-full md:w-72 bg-gradient-to-br from-[#33C0F1] to-[#1E2D93] text-white p-7 md:fixed md:h-full top-0 left-0 z-10 font-sans"> 
        <img class="h-24 mx-auto mb-4" src="{% static 'Images/logo2.png' %}" alt="Logo" />
        <ul class="space-y-4 text-lg">
            <li><a href="{% url 'gestioncitas' %}" class="block hover:bg-white/20 p-2 rounded">Citas Solicitadas</a></li>
            <li><a href="{% url 'registroc' %}" class="block hover:bg-white/20 p-2 rounded">Registro Citas</a></li>
            <li><a href="{% url 'usuarios' %}" class="block bg-white/30 hover:bg-white/40 p-2 rounded text-gray-900">Gestión de Usuario</a></li>
            <li><a href="{% url 'Tipdelasemana' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Tip de la Semana</a></li>
            <li><a href="{% url 'Galeria' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Galería</a></li>
            <li><a href="{% url 'modificarservicio' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Servicios</a></li>
            <li><a href="{% url 'backup' %}" class="block hover:bg-white/20 p-2 rounded">Copia de seguridad</a></li>
            <li><a href="{% url 'logout' %}" class="block hover:bg-red-500/80 p-2 rounded">Cerrar sesión</a></li>
        </ul>
        
        <!-- Información del usuario -->
        <div class="user-info">
            <div class="text-center">
                <p class="font-bold">Usuario:</p>
                <p>{{ request.user.nombre_completo }}</p>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="table-container">
        <h1 class="text-2xl font-bold mb-6">Gestión de Usuarios Administradores</h1>
        
        <!-- Botón de filtros y campos de filtrado -->
        <div class="mb-6">
            <button id="btnMostrarFiltros" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4">
                <i class="fas fa-filter"></i> Filtrar
            </button>
            
            <div id="filtrosContainer" class="hidden bg-white p-4 rounded-lg shadow-md mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Documento</label>
                        <input type="text" id="filtroDocumento" placeholder="Buscar por documento..."
                            class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="filtroNombre" placeholder="Buscar por nombre..."
                            class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
                        <input type="text" id="filtroCorreo" placeholder="Buscar por correo..."
                            class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="text" id="filtroTelefono" placeholder="Buscar por teléfono..."
                            class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <select id="filtroEstado" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Todos</option>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnLimpiarFiltros" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabla de usuarios -->
        <table>
            <thead>
                <tr>
                    <th>Documento</th>
                    <th>Nombre Completo</th>
                    <th>Correo Electrónico</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for admin in administradores %}
                <tr>
                    <td>{{ admin.documento }}</td>
                    <td>{{ admin.nombre_completo }}</td>
                    <td>{{ admin.correo_electronico }}</td>
                    <td>{{ admin.telefono }}</td>
                    <td>
                        {% if admin.is_active %}
                            <span class="text-green-600">Activo</span>
                        {% else %}
                            <span class="text-red-600">Inactivo</span>
                        {% endif %}
                    </td>
                    <td class="action-buttons">
                        <button class="btn-editar bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-documento="{{ admin.documento }}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-eliminar bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-documento="{{ admin.documento }}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <button class="toggle-estado bg-{{ admin.is_active|yesno:'yellow,green' }}-500 text-white px-3 py-1 rounded hover:bg-{{ admin.is_active|yesno:'yellow,green' }}-600" data-documento="{{ admin.documento }}">
                            <i class="fas fa-{{ admin.is_active|yesno:'ban,check' }}"></i> {{ admin.is_active|yesno:'Desactivar,Activar' }}
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">No hay usuarios registrados</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Botón para agregar nuevo usuario -->
        <div class="mt-6">
            <button id="btnNuevoUsuario" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                <i class="fas fa-plus-circle"></i> Agregar Nuevo Administrador
            </button>
        </div>
    </div>

    <!-- Modal para crear/editar usuario -->
    <div id="usuarioModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Nuevo Administrador</h2>
            <form id="usuarioForm" method="POST" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="documento" id="inputDocumento">
                
                <div class="form-group">
                    <label for="inputNombre" class="block text-sm font-medium text-gray-700">Nombre Completo *</label>
                    <input type="text" name="nombre_completo" id="inputNombre" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+" title="Solo letras y espacios">
                    <div id="nombreError" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="inputCorreo" class="block text-sm font-medium text-gray-700">Correo Electrónico *</label>
                    <input type="email" name="correo_electronico" id="inputCorreo" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="Ingrese un correo válido">
                    <div id="correoError" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="inputTelefono" class="block text-sm font-medium text-gray-700">Teléfono *</label>
                    <input type="tel" name="telefono" id="inputTelefono" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        pattern="[0-9]{7,10}" title="Mínimo 7, máximo 10 números" maxlength="10">
                    <div id="telefonoError" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="inputDocumentoLogin" class="block text-sm font-medium text-gray-700">Documento (para inicio de sesión) *</label>
                    <input type="text" name="documento_login" id="inputDocumentoLogin" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        pattern="[0-9]{7,10}" title="Solo números (7-10 dígitos)" maxlength="10">
                    <div id="documentoError" class="error-message"></div>
                </div>
                
                <!-- Campos de contraseña (solo visibles en creación) -->
                <div id="passwordFields">
                    <div class="form-group relative">
                        <label for="inputPassword" class="block text-sm font-medium text-gray-700">Contraseña *</label>
                        <input type="password" name="password" id="inputPassword" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('inputPassword')"></i>
                        <div id="passwordError" class="error-message"></div>
                    </div>
                    
                    <div class="form-group relative">
                        <label for="inputConfirmPassword" class="block text-sm font-medium text-gray-700">Confirmar Contraseña *</label>
                        <input type="password" name="confirm_password" id="inputConfirmPassword" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('inputConfirmPassword')"></i>
                        <div id="confirmPasswordError" class="error-message"></div>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="is_active" id="inputActivo" checked
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="inputActivo" class="ml-2 block text-sm text-gray-900">Usuario activo</label>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="cerrarModal()"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" id="submitButton"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Crear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Completo -->
    <script>
        // Variables globales
        let isEditMode = false;
        let currentDocumento = '';
        let timeoutId;
        const delay = 300; // Retardo en ms para la búsqueda en tiempo real

        // Funciones del modal
        function abrirModal() {
            document.getElementById('usuarioModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('usuarioModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetForm();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Funciones del formulario
        function resetForm() {
            const form = document.getElementById('usuarioForm');
            form.reset();
            clearErrors();
            
            isEditMode = false;
            currentDocumento = '';
            document.getElementById('modalTitle').textContent = 'Nuevo Administrador';
            document.getElementById('submitButton').textContent = 'Crear';
            
            // Mostrar campos de contraseña y hacerlos requeridos
            document.getElementById('passwordFields').style.display = 'block';
            document.getElementById('inputPassword').required = true;
            document.getElementById('inputConfirmPassword').required = true;
            
            // Habilitar edición de documento
            document.getElementById('inputDocumentoLogin').readOnly = false;
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        // Validación en tiempo real
        document.getElementById('inputDocumentoLogin').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });

        document.getElementById('inputTelefono').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });

        document.getElementById('inputNombre').addEventListener('input', function(e) {
            // Permitir solo letras y espacios
            this.value = this.value.replace(/[^A-Za-záéíóúÁÉÍÓÚñÑ\s]/g, '');
        });

        // Funciones para mostrar/ocultar filtros
        document.getElementById('btnMostrarFiltros').addEventListener('click', function() {
            const filtros = document.getElementById('filtrosContainer');
            const icono = this.querySelector('i');
            
            // Alternar visibilidad
            filtros.classList.toggle('hidden');
            
            // Cambiar ícono y estilo del botón
            if (filtros.classList.contains('hidden')) {
                this.classList.remove('bg-blue-600');
                this.classList.add('bg-blue-500');
                icono.classList.remove('fa-times');
                icono.classList.add('fa-filter');
            } else {
                this.classList.remove('bg-blue-500');
                this.classList.add('bg-blue-600');
                icono.classList.remove('fa-filter');
                icono.classList.add('fa-times');
            }
        });

        // Funciones de filtrado
        async function aplicarFiltros() {
            try {
                // Obtener valores de los filtros
                const filtros = {
                    documento: document.getElementById('filtroDocumento').value,
                    nombre: document.getElementById('filtroNombre').value,
                    correo: document.getElementById('filtroCorreo').value,
                    telefono: document.getElementById('filtroTelefono').value,
                    estado: document.getElementById('filtroEstado').value
                };

                // Mostrar carga
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Buscando usuarios...</td></tr>';

                // Construir URL con parámetros
                const params = new URLSearchParams();
                for (const key in filtros) {
                    if (filtros[key]) {
                        params.append(key, filtros[key]);
                    }
                }

                // Hacer la petición AJAX
                const response = await fetch(`/usuarios/?${params.toString()}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `Error HTTP: ${response.status}`);
                }

                // Procesar la respuesta
                const data = await response.json();
                
                if (!data.administradores) {
                    throw new Error('Formato de respuesta inesperado');
                }

                // Actualizar la tabla
                actualizarTabla(data.administradores);
                
            } catch (error) {
                console.error('Error en aplicarFiltros:', error);
                
                // Mostrar mensaje de error en la tabla
                document.querySelector('tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-500">
                            Error: ${error.message}
                        </td>
                    </tr>
                `;
                
                // Mostrar alerta con más detalles
                Swal.fire({
                    icon: 'error',
                    title: 'Error al filtrar',
                    html: `No se pudieron cargar los datos.<br><small>${error.message}</small>`,
                    confirmButtonText: 'Entendido'
                });
            }
        }

        function actualizarTabla(administradores) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!administradores || administradores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            No se encontraron usuarios con los filtros aplicados
                        </td>
                    </tr>
                `;
                return;
            }
            
            administradores.forEach(admin => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${admin.documento}</td>
                    <td>${admin.nombre_completo}</td>
                    <td>${admin.correo_electronico}</td>
                    <td>${admin.telefono}</td>
                    <td>
                        ${admin.is_active ? '<span class="text-green-600">Activo</span>' : '<span class="text-red-600">Inactivo</span>'}
                    </td>
                    <td class="action-buttons">
                        <button class="btn-editar bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-documento="${admin.documento}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-eliminar bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-documento="${admin.documento}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <button class="toggle-estado bg-${admin.is_active ? 'yellow' : 'green'}-500 text-white px-3 py-1 rounded hover:bg-${admin.is_active ? 'yellow' : 'green'}-600" data-documento="${admin.documento}">
                            <i class="fas fa-${admin.is_active ? 'ban' : 'check'}"></i> ${admin.is_active ? 'Desactivar' : 'Activar'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Reasignar eventos a los nuevos botones
            asignarEventListeners();
        }

        // Limpiar filtros
        document.getElementById('btnLimpiarFiltros').addEventListener('click', async function() {
            // Limpiar los campos de filtro
            document.getElementById('filtroDocumento').value = '';
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroCorreo').value = '';
            document.getElementById('filtroTelefono').value = '';
            document.getElementById('filtroEstado').value = '';
            
            // Mostrar carga
            document.querySelector('tbody').innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Cargando todos los usuarios...</td></tr>';
            
            try {
                // Hacer una nueva petición sin filtros
                const response = await fetch('/usuarios/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar usuarios');
                }
                
                const data = await response.json();
                actualizarTabla(data.administradores);
                
            } catch (error) {
                console.error('Error al limpiar filtros:', error);
                document.querySelector('tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-500">
                            Error al cargar usuarios: ${error.message}
                        </td>
                    </tr>
                `;
            }
        });

        // Event listeners para filtros en tiempo real
        document.getElementById('filtroDocumento').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroNombre').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroCorreo').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroTelefono').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);

        // Funciones para asignar event listeners
        function asignarEventListeners() {
            // Delegación de eventos para elementos dinámicos
            document.addEventListener('click', function(e) {
                // Editar
                if (e.target.closest('.btn-editar')) {
                    cargarUsuarioParaEditar(e.target.closest('.btn-editar').dataset.documento);
                }
                // Eliminar
                else if (e.target.closest('.btn-eliminar')) {
                    eliminarUsuario(e.target.closest('.btn-eliminar').dataset.documento);
                }
                // Cambiar estado
                else if (e.target.closest('.toggle-estado')) {
                    toggleEstadoUsuario(e.target.closest('.toggle-estado').dataset.documento);
                }
            });
        }

        // Funciones de negocio
        async function cargarUsuarioParaEditar(documento) {
            try {
                const response = await fetch(`/usuarios/editar/${documento}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }
                
                const data = await response.json();

                // Configurar modal en modo edición
                isEditMode = true;
                currentDocumento = documento;
                document.getElementById('modalTitle').textContent = 'Editar Administrador';
                document.getElementById('submitButton').textContent = 'Actualizar';
                
                // Llenar formulario
                document.getElementById('inputDocumento').value = data.documento;
                document.getElementById('inputNombre').value = data.nombre_completo;
                document.getElementById('inputCorreo').value = data.correo_electronico;
                document.getElementById('inputTelefono').value = data.telefono;
                document.getElementById('inputDocumentoLogin').value = data.documento;
                document.getElementById('inputActivo').checked = data.is_active;
                
                // Ocultar campos de contraseña en edición
                document.getElementById('passwordFields').style.display = 'none';
                document.getElementById('inputPassword').required = false;
                document.getElementById('inputConfirmPassword').required = false;
                
                // Bloquear edición de documento
                document.getElementById('inputDocumentoLogin').readOnly = true;
                
                abrirModal();
            } catch (error) {
                console.error('Error al cargar usuario:', error);
                Swal.fire('Error', 'No se pudieron cargar los datos del usuario', 'error');
            }
        }

        async function eliminarUsuario(documento) {
            try {
                const usuarioActual = "{{ request.user.documento }}"; // Obtener documento del usuario logueado
                
                // Mensaje diferente si intenta eliminarse a sí mismo
                const mensajeConfirmacion = (documento === usuarioActual) 
                    ? "Si eliminas tu cuenta, se cerrará la sesión automáticamente y no podras volver a ingresar. ¿Deseas continuar?"
                    : "¡No podrás revertir esta acción!";

                const result = await Swal.fire({
                    title: '¿Estás seguro?',
                    html: mensajeConfirmacion,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/usuarios/eliminar/${documento}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Eliminar la fila de la tabla sin recargar
                        const fila = document.querySelector(`.btn-eliminar[data-documento="${documento}"]`).closest('tr');
                        fila.remove();
                        
                        // Mostrar mensaje de éxito
                        await Swal.fire({
                            icon: 'success',
                            title: '¡Eliminado!',
                            text: 'El usuario ha sido eliminado correctamente',
                            confirmButtonText: 'Aceptar'
                        });
                        
                        // Si se eliminó a sí mismo, redirigir al login
                        if (documento === usuarioActual) {
                            window.location.href = "{% url 'logout' %}";
                        }
                        
                        // Si la tabla queda vacía, mostrar mensaje
                        if (document.querySelector('tbody').children.length === 0) {
                            document.querySelector('tbody').innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center py-4">No hay usuarios registrados</td>
                                </tr>
                            `;
                        }
                    } else {
                        throw new Error(data.message || 'Error al eliminar el usuario');
                    }
                }
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo eliminar el usuario',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        function validarFormulario() {
            let isValid = true;
            clearErrors();

            // Validar campos requeridos (todos menos contraseña en edición)
            const camposRequeridos = [
                'inputNombre', 'inputCorreo', 
                'inputTelefono', 'inputDocumentoLogin'
            ];

            // Validaciones específicas
            const nombre = document.getElementById('inputNombre').value;
            if (nombre && !/^[A-Za-záéíóúÁÉÍÓÚñÑ\s]+$/.test(nombre)) {
                document.getElementById('nombreError').textContent = 'Solo se permiten letras y espacios';
                isValid = false;
            }

            const documento = document.getElementById('inputDocumentoLogin').value;
            if (documento && !/^\d{7,10}$/.test(documento)) {
                document.getElementById('documentoError').textContent = 'Documento debe tener 7-10 dígitos';
                isValid = false;
            }

            const telefono = document.getElementById('inputTelefono').value;
            if (telefono && !/^\d{7,10}$/.test(telefono)) {
                document.getElementById('telefonoError').textContent = 'Teléfono debe tener 7-10 dígitos';
                isValid = false;
            }

            const email = document.getElementById('inputCorreo').value;
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('correoError').textContent = 'Ingrese un correo válido';
                isValid = false;
            }

            // Solo validar contraseñas en modo creación
            if (!isEditMode) {
                camposRequeridos.push('inputPassword', 'inputConfirmPassword');
                
                const password = document.getElementById('inputPassword').value;
                const confirmPassword = document.getElementById('inputConfirmPassword').value;
                
                if (password.length < 8) {
                    document.getElementById('passwordError').textContent = 'Mínimo 8 caracteres';
                    isValid = false;
                }
                
                if (password !== confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = 'Las contraseñas no coinciden';
                    isValid = false;
                }
            }

            // Validar campos requeridos
            camposRequeridos.forEach(id => {
                const campo = document.getElementById(id);
                if (!campo.value.trim()) {
                    document.getElementById(`${id}Error`).textContent = 'Campo obligatorio';
                    isValid = false;
                }
            });

            return isValid;
        }

        async function enviarFormulario() {
            if (!validarFormulario()) return;

            const formData = new FormData(document.getElementById('usuarioForm'));
            const url = isEditMode 
                ? `/usuarios/editar/${currentDocumento}/` 
                : `/usuarios/crear/`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `Error ${response.status}`);
                }

                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: isEditMode ? 'Usuario actualizado correctamente' : 'Usuario creado correctamente',
                        icon: 'success'
                    }).then(() => {
                        cerrarModal();
                        window.location.reload();
                    });
                } else if (data.errors) {
                    // Mostrar errores de validación del servidor
                    Object.entries(data.errors).forEach(([field, message]) => {
                        const errorElement = document.getElementById(`${field}Error`);
                        if (errorElement) {
                            errorElement.textContent = message;
                        }
                    });
                }
            } catch (error) {
                console.error('Error al enviar formulario:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al procesar la solicitud',
                    icon: 'error'
                });
            }
        }

        async function toggleEstadoUsuario(documento) {
            try {
                const usuarioActual = "{{ request.user.documento }}";
                const esUsuarioActual = (documento === usuarioActual);
                const accion = document.querySelector(`.toggle-estado[data-documento="${documento}"]`).textContent.trim();
                
                // Mensaje personalizado para auto-desactivación
                let mensajeConfirmacion = `¿Deseas ${accion.toLowerCase()} este usuario?`;
                
                if (esUsuarioActual && accion.includes("Desactivar")) {
                    mensajeConfirmacion = "Si desactivas tu cuenta, se cerrará la sesión automáticamente y no podrás volver a ingresar. ¿Deseas continuar?";
                }

                const result = await Swal.fire({
                    title: 'Confirmación',
                    html: mensajeConfirmacion,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Continuar',
                    cancelButtonText: 'Cancelar'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/usuarios/toggle-estado/${documento}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Actualizar el estado en la tabla
                        const fila = document.querySelector(`.toggle-estado[data-documento="${documento}"]`).closest('tr');
                        const estadoCelda = fila.querySelector('td:nth-child(5)');
                        
                        if (data.is_active) {
                            estadoCelda.innerHTML = '<span class="text-green-600">Activo</span>';
                            fila.querySelector('.toggle-estado').innerHTML = '<i class="fas fa-ban"></i> Desactivar';
                            fila.querySelector('.toggle-estado').className = 'toggle-estado bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600';
                        } else {
                            estadoCelda.innerHTML = '<span class="text-red-600">Inactivo</span>';
                            fila.querySelector('.toggle-estado').innerHTML = '<i class="fas fa-check"></i> Activar';
                            fila.querySelector('.toggle-estado').className = 'toggle-estado bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600';
                        }
                        
                        // Mostrar mensaje de éxito
                        await Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: data.message,
                            confirmButtonText: 'Aceptar'
                        });
                        
                        // Si se desactivó a sí mismo, redirigir al login
                        if (esUsuarioActual && !data.is_active) {
                            window.location.href = "{% url 'logout' %}";
                        }
                    } else {
                        throw new Error(data.message || 'Error al cambiar el estado');
                    }
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo cambiar el estado del usuario',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Botón nuevo usuario
            document.getElementById('btnNuevoUsuario').addEventListener('click', function(e) {
                e.preventDefault();
                resetForm();
                abrirModal();
            });

            // Inicializar event listeners
            asignarEventListeners();

            // Submit del formulario
            document.getElementById('usuarioForm').addEventListener('submit', function(e) {
                e.preventDefault();
                enviarFormulario();
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('usuarioModal')) {
                    cerrarModal();
                }
            });

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                }
            });
        });
    </script>
</body>
</html>