{%load static%}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Citas</title>
  <link rel="icon" href="{% static 'Images/logo.png' %}"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    
  </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Sidebar -->
    <div class="w-full md:w-72 bg-gradient-to-br from-[#33C0F1] to-[#1E2D93] text-white p-7 md:fixed md:h-full top-0 left-0 z-10 font-sans"> 
        <img class="h-24 mx-auto mb-4" src="{% static 'Images/logo2.png' %}" alt="Logo" />
        <ul class="space-y-4 text-lg">
            <li><a href="{% url 'gestioncitas' %}" class="block hover:bg-white/20 p-2 rounded">Citas Solicitadas</a></li>
            <li><a href="{% url 'registroc' %}" class="block bg-white/30 hover:bg-white/40 p-2 rounded text-gray-900">Registro Citas</a></li>
            <li><a href="{% url 'Tipdelasemana' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Tip de la Semana</a></li>
            <li><a href="{% url 'Galeria' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Galer√≠a</a></li>
            <li><a href="{% url 'modificarservicio' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Servicios</a></li>
            <li><a href="{% url 'backup' %}" class="block hover:bg-white/20 p-2 rounded">Copia de seguridad</a></li>
            <li><a href="{% url 'index' %}" class="block hover:bg-red-500/80 p-2 rounded">Cerrar sesi√≥n</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="flex-1 md:ml-72 p-6 fade-in">
      <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-3xl font-bold mb-6 text-blue-800">üìÖ Registro de Citas</h2>

        <!-- Mensaje de √©xito -->
        <div id="mensaje-exito" class="hidden mb-4 p-3 rounded-md bg-green-100 text-green-800 text-sm font-medium transition duration-300">
          ‚úÖ Cita agregada exitosamente.
        </div>

        <!-- Formulario para nuevas citas -->
        <form method="post" class="mb-6 bg-white p-4 rounded shadow" id="form-cita">
  {% csrf_token %}
  <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
    <div class="flex flex-col">
      <label for="numero_documento" class="text-xs font-semibold mb-1 text-gray-700">Documento del cliente</label>
      <input type="text" name="numero_documento" id="numero_documento" placeholder="Documento" required
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm" />
    </div>
    <div class="flex flex-col">
      <label for="nombre_cliente" class="text-xs font-semibold mb-1 text-gray-700">Nombre del cliente</label>
      <input type="text" name="nombre_cliente" id="nombre_cliente" placeholder="Nombre" required
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm" />
    </div>
    <div class="flex flex-col">
      <label for="fecha" class="text-xs font-semibold mb-1 text-gray-700">Fecha</label>
      <input type="date" name="fecha" id="fecha" required
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm" />
    </div>
    <div class="flex flex-col">
      <label for="hora" class="text-xs font-semibold mb-1 text-gray-700">Hora</label>
      <input type="time" name="hora" id="hora"
        min="06:00" max="18:00" step="1200"
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm" required />
    </div>
    <div class="flex flex-col">
      <label for="servicio" class="text-xs font-semibold mb-1 text-gray-700">Servicio</label>
      <select name="servicio" id="servicio" required
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm">
        <option value="" disabled selected>Seleccione un servicio</option>
        <option value="Consulta">Consulta</option>
        <option value="Esterilizaci√≥n Canina y Felina">Esterilizaci√≥n Canina y Felina</option>
        <option value="Guarder√≠a">Guarder√≠a</option>
        <option value="Vacunaci√≥n">Vacunaci√≥n</option>
        <option value="Profilaxis">Profilaxis</option>
        <option value="Hospitalizaci√≥n">Hospitalizaci√≥n</option>
        <option value="Cirug√≠as">Cirug√≠as</option>
        <option value="Asistencia M√©dica">Asistencia M√©dica</option>
      </select>
    </div>
    <div class="flex flex-col">
      <label for="estado" class="text-xs font-semibold mb-1 text-gray-700">Estado</label>
      <select name="estado" id="estado" required
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm">
        <option value="Pendiente" selected>Pendiente</option>
        <option value="Completada">Completada</option>
        <option value="Cancelada">Cancelada</option>
        <option value="Realizada">Realizada</option>
      </select>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <div class="flex flex-col">
      <label for="observaciones" class="text-xs font-semibold mb-1 text-gray-700">Observaciones</label>
      <input type="text" name="observaciones" id="observaciones" placeholder="Observaciones"
        class="border p-2 rounded-md focus:ring-2 focus:ring-blue-400 text-sm" />
    </div>
    <div class="flex items-end">
      <button type="submit"
        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 active:scale-95 transition font-semibold">
        Agregar Cita
      </button>
    </div>
  </div>
</form>

        <!-- Mensaje de error -->
        {% if form.errors %}
          <div class="text-red-500 text-xs">
            {{ form.errors }}
          </div>
        {% endif %}

        <!-- Filtros organizados en dos filas -->
        <div class="mb-4">
          <div class="flex flex-wrap gap-2 mb-2">
            <input type="text" id="filtro-documento" placeholder="Filtrar Documento" class="border p-1 rounded text-xs flex-1 min-w-[150px]" />
            <input type="text" id="filtro-cliente" placeholder="Filtrar Cliente" class="border p-1 rounded text-xs flex-1 min-w-[150px]" />
            <input type="date" id="filtro-fecha" class="border p-1 rounded text-xs flex-1 min-w-[130px]" />
            <input type="time" id="filtro-hora" class="border p-1 rounded text-xs flex-1 min-w-[110px]" />
          </div>
          <div class="flex flex-wrap gap-2">
            <input type="text" id="filtro-servicio" placeholder="Filtrar Servicio" class="border p-1 rounded text-xs flex-1 min-w-[150px]" />
            <select id="filtro-estado" class="border p-1 rounded text-xs flex-1 min-w-[140px]">
              <option value="">Todos los estados</option>
              <option value="completada">Completada</option>
              <option value="pendiente">Pendiente</option>
              <option value="cancelada">Cancelada</option>
            </select>
            <input type="text" id="filtro-observaciones" placeholder="Filtrar Observaciones" class="border p-1 rounded text-xs flex-1 min-w-[150px]" />
            <button id="btn-limpiar-filtros" class="bg-gray-200 px-2 rounded text-xs">Limpiar</button>
          </div>
        </div>

        <!-- Tabla -->
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200 text-sm" id="tabla-citas">
            <thead class="bg-gray-100 text-gray-700 font-semibold">
              <tr>
                <th class="px-4 py-2 text-left">Documento</th>
                <th class="px-4 py-2 text-left">Cliente</th>
                <th class="px-4 py-2 text-left">Fecha</th>
                <th class="px-4 py-2 text-left">Hora</th>
                <th class="px-4 py-2 text-left">Servicio</th>
                <th class="px-4 py-2 text-left">Estado</th>
                <th class="px-4 py-2 text-left">Observaciones</th>
              </tr>
            </thead>
            <tbody id="cuerpo-tabla" class="divide-y divide-gray-200 text-gray-700">
              {% for cita in citas_rapidas %}
              <tr>
    <td>{{ cita.numero_documento }}</td>
    <td>{{ cita.nombre_cliente }}</td>
    <td>
        <form method="post" action="{% url 'editar_estado_observacion_rapida' cita.id %}">
            {% csrf_token %}
            <input type="date" name="fecha" value="{{ cita.fecha|date:'Y-m-d' }}" class="border rounded p-1 text-xs w-full" required />
    </td>
    <td>
            <input type="time" name="hora" value="{{ cita.hora|time:'H:i' }}"
  min="06:00" max="18:00" step="1200"
  class="border rounded p-1 text-xs w-full" required />
    </td>
    <td>{{ cita.servicio }}</td>
    <td>
            <select name="estado" class="border rounded p-1 text-xs w-full">
                <option value="Completada" {% if cita.estado == "Completada" %}selected{% endif %}>Completada</option>
                <option value="Pendiente" {% if cita.estado == "Pendiente" %}selected{% endif %}>Pendiente</option>
                <option value="Cancelada" {% if cita.estado == "Cancelada" %}selected{% endif %}>Cancelada</option>
            </select>
    </td>
    <td>
            <div class="flex gap-2 items-center">
                <input type="text" name="observaciones" value="{{ cita.observaciones }}" class="border rounded p-1 text-xs w-full" />
                <button type="submit" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2">Guardar</button>
            </div>
        </form>
    </td>
</tr>
              {% endfor %}

              {% for cita in citas_normales %}
              <tr>
    <td>{{ cita.cliente.numero_documento }}</td>
    <td>{{ cita.cliente.primer_nombre }} {{ cita.cliente.primer_apellido }}</td>
    <td>
        <form method="post" action="{% url 'editar_estado_observacion_normal' cita.id %}">
            {% csrf_token %}
            <input type="date" name="fecha" value="{{ cita.fecha|date:'Y-m-d' }}" class="border rounded p-1 text-xs w-full" required />
    </td>
    <td>
            <input type="time" name="hora" value="{{ cita.horario|time:'H:i' }}"
  min="06:00" max="18:00" step="1200"
  class="border rounded p-1 text-xs w-full" required />
    </td>
    <td>{{ cita.extra }}</td>
    <td>
            <select name="estado" class="border rounded p-1 text-xs w-full">
                <option value="Completada" {% if cita.estado == "Completada" %}selected{% endif %}>Completada</option>
                <option value="Pendiente" {% if cita.estado == "Pendiente" %}selected{% endif %}>Pendiente</option>
                <option value="Cancelada" {% if cita.estado == "Cancelada" %}selected{% endif %}>Cancelada</option>
            </select>
    </td>
    <td>
            <div class="flex gap-2 items-center">
                <input type="text" name="observaciones" value="{{ cita.observaciones }}" class="border rounded p-1 text-xs w-full" />
                <button type="submit" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2">Guardar</button>
            </div>
        </form>
    </td>
</tr>
              {% endfor %}
              {% if not citas_rapidas and not citas_normales %}
              <tr>
                  <td colspan="6">No hay citas registradas.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const filtros = {
  documento: document.getElementById('filtro-documento'),
  cliente: document.getElementById('filtro-cliente'),
  fecha: document.getElementById('filtro-fecha'),
  hora: document.getElementById('filtro-hora'),
  servicio: document.getElementById('filtro-servicio'),
  estado: document.getElementById('filtro-estado'),
  observaciones: document.getElementById('filtro-observaciones')
};
      const tabla = document.getElementById('tabla-citas').getElementsByTagName('tbody')[0];
      const filas = tabla.getElementsByTagName('tr');

      function filtrarTabla() {
        for (let fila of filas) {
          // Si es la fila de "No hay citas registradas", siempre mostrar
          if (fila.querySelector('td[colspan]')) {
            fila.style.display = '';
            continue;
          }
          let mostrar = true;
          // Documento
          if (filtros.documento && filtros.documento.value) {
            const textoDocumento = fila.cells[0].textContent.toLowerCase();
            if (!textoDocumento.includes(filtros.documento.value.toLowerCase())) mostrar = false;
          }
          // Cliente
          if (filtros.cliente.value) {
            const palabras = filtros.cliente.value.toLowerCase().split(' ').filter(Boolean);
            const textoCliente = fila.cells[1].textContent.toLowerCase();
            for (let palabra of palabras) {
              if (!textoCliente.includes(palabra)) {
                mostrar = false;
                break;
              }
            }
          }
          // Fecha (input)
          if (filtros.fecha.value) {
            const inputFecha = fila.cells[2].querySelector('input[type="date"]');
            if (!inputFecha || inputFecha.value !== filtros.fecha.value) mostrar = false;
          }
          // Hora (input)
          if (filtros.hora.value) {
            const inputHora = fila.cells[3].querySelector('input[type="time"]');
            if (!inputHora || inputHora.value !== filtros.hora.value) mostrar = false;
          }
          // Servicio
          if (filtros.servicio.value && !fila.cells[4].textContent.toLowerCase().includes(filtros.servicio.value.toLowerCase())) mostrar = false;
          // Estado (select)
          if (filtros.estado.value) {
  const selectEstado = fila.cells[5].querySelector('select');
  // Compara el valor del select (en min√∫sculas) con el filtro (tambi√©n en min√∫sculas)
  if (!selectEstado || selectEstado.value.toLowerCase() !== filtros.estado.value.toLowerCase()) mostrar = false;
}
          // Observaciones (input)
          if (filtros.observaciones.value) {
  const inputObs = fila.cells[6].querySelector('input[type="text"]');
  if (!inputObs || !inputObs.value.toLowerCase().includes(filtros.observaciones.value.toLowerCase())) mostrar = false;
}
          fila.style.display = mostrar ? '' : 'none';
        }
      }

      Object.values(filtros).forEach(input => {
        input.addEventListener('input', filtrarTabla);
        if (input.tagName === 'SELECT') input.addEventListener('change', filtrarTabla);
      });

      document.getElementById('btn-limpiar-filtros').addEventListener('click', function(){
        Object.values(filtros).forEach(input => input.value = '');
        filtrarTabla();
      });
    });

    document.querySelectorAll('input[type="time"]').forEach(input => {
  input.addEventListener('change', function() {
    const value = this.value;
    if (!value) return;
    const [h, m] = value.split(':').map(Number);
    if (h < 6 || h > 18 || ![0, 20, 40].includes(m)) {
      alert('Seleccione una hora entre 6:00 y 18:00, en intervalos de 20 minutos (00, 20, 40).');
      this.value = '';
    }
  });
});
  </script>
</body>
</html>