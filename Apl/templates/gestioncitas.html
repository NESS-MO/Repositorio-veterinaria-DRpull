{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Citas - Veterinaria</title>
    <link rel="icon" href="{% static 'Images/logo.png' %}"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/GestionCitas.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="w-full md:w-72 bg-gradient-to-br from-[#33C0F1] to-[#1E2D93] text-white p-7 md:fixed md:h-full top-0 left-0 z-10 font-sans"> 
        <img class="h-24 mx-auto mb-4" src="{% static 'Images/logo2.png' %}" alt="Logo" />
        <ul class="space-y-4 text-lg">
            <li><a href="{% url 'gestioncitas' %}" class="block bg-white/30 hover:bg-white/40 p-2 rounded text-gray-900">Citas Solicitadas</a></li>
            <li><a href="{% url 'registroc' %}" class="block hover:bg-white/20 p-2 rounded">Registro Citas</a></li>
            <li><a href="{% url 'Tipdelasemana' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Tip de la Semana</a></li>
            <li><a href="{% url 'Galeria' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Galería</a></li>
            <li><a href="{% url 'modificarservicio' %}" class="block hover:bg-white/20 p-2 rounded">Modificar Servicios</a></li>
            <li><a href="{% url 'backup' %}" class="block hover:bg-white/20 p-2 rounded">Copia de seguridad</a></li>
            <li><a href="{% url 'index' %}" class="block hover:bg-red-500/80 p-2 rounded">Cerrar sesión</a></li>
        </ul>
    </div>
    <section>
        <h1>Panel de Administración de Citas</h1>

        <button id="toggle-filtros" class="mb-4 px-4 py-2 bg-blue-500 text-white rounded shadow flex items-center gap-2">
            <i class="fas fa-sliders-h"></i>
            <span>Filtros</span>
        </button>

        <div class="filtro-campos" id="contenedor-filtros">
            <div class="campo">
                <label for="filtro-nombre">Nombre</label>
                <input type="text" id="filtro-nombre" placeholder="Nombre">
            </div>
            <div class="campo">
                <label for="filtro-correo">Correo</label>
                <input type="text" id="filtro-correo" placeholder="Correo">
            </div>
            <div class="campo">
                <label for="filtro-telefono">Teléfono</label>
                <input type="text" id="filtro-telefono" placeholder="Teléfono">
            </div>
            <div class="campo">
                <label for="filtro-mascota">Mascota</label>
                <input type="text" id="filtro-mascota" placeholder="Mascota">
            </div>
            <div class="campo">
                <label for="filtro-fecha">Fecha</label>
                <input type="date" id="filtro-fecha">
            </div>
            <div class="campo">
                <label for="filtro-hora">Hora</label>
                <input type="time" id="filtro-hora">
            </div>
            <div class="campo">
                <label for="filtro-servicio">Servicios</label>
                <input type="text" id="filtro-servicio" placeholder="Servicios">
            </div>
            <div class="campo">
                <button id="btn-limpiar" type="button">Limpiar</button>
            </div>
        </div>

        <div id="loading" style="display: none;">
            <img src="{% static 'Images/loading.gif' %}" alt="Cargando...">
        </div>

        <table id="tabla-citas" class="min-w-full bg-white border border-gray-200">
            <thead>
                <tr class="bg-gray-100 text-gray-700">
                    <th class="p-3 text-left">Nombre</th>
                    <th class="p-3 text-left">Correo</th>
                    <th class="p-3 text-left">Teléfono</th>
                    <th class="p-3 text-left">Mascota</th>
                    <th class="p-3 text-left">Fecha</th>
                    <th class="p-3 text-left">Hora</th>
                    <th class="p-3 text-left">Servicios</th>
                    <th class="p-3 text-left">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in citas %}
                <tr>
                    <td>{{ cita.cliente.primer_nombre }} {{ cita.cliente.primer_apellido }}</td>
                    <td>{{ cita.cliente.correo_electronico }}</td>
                    <td>{{ cita.cliente.telefono }}</td>
                    <td>
                        {% if cita.cliente.mascotas.all %}
                            {{ cita.cliente.mascotas.first.nombre_mascota }}
                        {% else %}
                            Sin mascota
                        {% endif %}
                    </td>
                    <td>{{ cita.fecha }}</td>
                    <td>{{ cita.horario }}</td>
                    <td>{{ cita.extra }}</td>
                    <td>
                        <form action="{% url 'aceptar_cita' cita.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="bg-green-500 text-white px-2 py-1 rounded">Aceptar</button>
                        </form>
                        <form action="{% url 'rechazar_cita' cita.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded">Rechazar</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">No hay citas agendadas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Mostrar/ocultar filtros usando la clase 'mostrar'
    const btnFiltros = document.getElementById('toggle-filtros');
    const contenedorFiltros = document.getElementById('contenedor-filtros');
    btnFiltros.addEventListener('click', function () {
        contenedorFiltros.classList.toggle('mostrar');
    });

    // Selecciona todos los inputs de filtro
    const filtros = {
        nombre: document.getElementById('filtro-nombre'),
        correo: document.getElementById('filtro-correo'),
        telefono: document.getElementById('filtro-telefono'),
        mascota: document.getElementById('filtro-mascota'),
        fecha: document.getElementById('filtro-fecha'),
        hora: document.getElementById('filtro-hora'),
        servicio: document.getElementById('filtro-servicio')
    };

    const tabla = document.getElementById('tabla-citas').getElementsByTagName('tbody')[0];
    const filas = tabla.getElementsByTagName('tr');

    function filtrarTabla() {
        for (let fila of filas) {
            // Si es la fila de "No hay citas agendadas", siempre mostrar
            if (fila.querySelector('td[colspan]')) {
                fila.style.display = '';
                continue;
            }
            let mostrar = true;
            // Filtra por cada campo
            if (filtros.nombre.value && !fila.cells[0].textContent.toLowerCase().includes(filtros.nombre.value.toLowerCase())) mostrar = false;
            if (filtros.correo.value && !fila.cells[1].textContent.toLowerCase().includes(filtros.correo.value.toLowerCase())) mostrar = false;
            if (filtros.telefono.value && !fila.cells[2].textContent.toLowerCase().includes(filtros.telefono.value.toLowerCase())) mostrar = false;
            if (filtros.mascota.value && !fila.cells[3].textContent.toLowerCase().includes(filtros.mascota.value.toLowerCase())) mostrar = false;
            if (filtros.fecha.value && !fila.cells[4].textContent.includes(filtros.fecha.value)) mostrar = false;
            if (filtros.hora.value && !fila.cells[5].textContent.includes(filtros.hora.value)) mostrar = false;
            if (filtros.servicio.value && !fila.cells[6].textContent.toLowerCase().includes(filtros.servicio.value.toLowerCase())) mostrar = false;
            fila.style.display = mostrar ? '' : 'none';
        }
    }

    // Asigna el evento a cada input
    Object.values(filtros).forEach(input => {
        input.addEventListener('input', filtrarTabla);
    });

    // Botón limpiar
    const btnLimpiar = document.getElementById('btn-limpiar');
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', function(e) {
            e.preventDefault();
            Object.values(filtros).forEach(input => input.value = '');
            filtrarTabla();
        });
    }
});
</script>
</body>
</html>
